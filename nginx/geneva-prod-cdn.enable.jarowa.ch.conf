server {
    	access_log /opt/bitnami/nginx/logs/cdn-ch-geneva-prod-access.log;
    	error_log /opt/bitnami/nginx/logs/cdn-ch-geneva-prod-error.log;

        listen [::]:443 ssl;
        listen      443 ssl;

        ssl_certificate /opt/bitnami/nginx/conf/bitnami/certs/wildcard-enable.jarowa.ch.crt;
        ssl_certificate_key /opt/bitnami/nginx/conf/bitnami/certs/wildcard-enable.jarowa.ch.rsa;
        ssl_trusted_certificate /opt/bitnami/nginx/conf/bitnami/certs/wildcard-enable.jarowa.ch.crt.chain.pem;

    	server_name cdn-prod.enable.jarowa.ch;
    	#uncomment after DNS change from A to CNAME fw-web-earth-prod.germanywestcentral.cloudapp.azure.com
        #server_name cdn.enable.jarowa.ch;

        ## https://gist.github.com/gavinhungry/7a67174c18085f4a23eb
        ssl_protocols TLSv1.3 TLSv1.2;
        ssl_prefer_server_ciphers on;
        ssl_ecdh_curve secp521r1:secp384r1;
        #ssl_ciphers EECDH+AESGCM:EECDH+AES256;
        ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES128-$';

        # reduce ssl caching to 2m: https://success.qualys.com/discussions/s/question/0D52L00004TntzWSAR/ssltest-protocol-details-session-resumption-caching-in-red-color
        ssl_session_cache shared:TLS:2m;
        ssl_session_cache shared:SSL:2m;
        ssl_session_timeout 2m;
        ssl_buffer_size 4k;

        ## https://crashtest-security.com/harden-tls-session-resumption/
        ssl_session_tickets off;

        # OCSP stapling
        ssl_stapling on;
        ssl_stapling_verify on;
        # we dont need a resolver - its defined in azure /etc/resolver.conf
        # resolver 1.1.1.1;
        resolver_timeout 10s;

        # Do not use 2048 (see SSLTEST rating guide)
        # we generated our own using: 
        ssl_dhparam /opt/bitnami/nginx/conf/bitnami/certs/dhparam.pem;

        # do not add this header because must be provided in every location
        # add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;


        # https://blog.adriaan.io/one-nginx-error-page-to-rule-them-all.html
        error_page 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 425 426 428 429 431 451 500 501 502 503 504 505 506 507 508 510 511 /error-pages/error.html;

        location /error-pages {
            ssi on;
            internal; ## served only internal
            auth_basic off;
            root /opt/bitnami/nginx/html;
        }

        location / {
              proxy_intercept_errors on;
       	      error_page 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 425 426 428 429 431 451 500 501 502 503 504 505 506 507 508 510 511 /error-pages/error.html;

              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

              proxy_set_header 'Access-Control-Allow-Credentials' 'true';
              proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

              # fix http version - 505 HTTP Version Not Supported
              proxy_http_version 1.1;

              add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

              ### we must redeclare the STS header because 'location' block contains another 'add_header' directive
              proxy_hide_header 'Strict-Transport-Security';
              ### and ensure to hide any headers from stream
              add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;

              rewrite ^/.*/$ /geneva-prod/cdn-ch/$1/index.html break;
              rewrite ^/$ /geneva-prod/cdn-ch/index.html break;
              rewrite ^/(.*)$ /geneva-prod/cdn-ch/$1 break;
              proxy_pass http://stcdnearthprod.privatelink.web.core.windows.net:80;
        }
}