upstream enable-auth-${postFix} {
        server ${hostLB}:8000;
}
upstream enable-api-${postFix} {
        server ${hostLB}:8001;
}

upstream enable-apiadmin-${postFix} {
	server ${hostLB}:8002;
}

upstream enable-storage-${postFix} {
        server ${hostLB}:8003;
}

upstream enable-chathub-${postFix} {
        server ${hostLB}:8010;
}

upstream enable-configui-${postFix} {
        server ${hostLB}:8020;
}

server {
	access_log /opt/bitnami/nginx/logs/${postFix}-access.log;
	error_log /opt/bitnami/nginx/logs/${postFix}-error.log;

	listen 443 ssl;
	listen [::]:443 ssl;

	ssl_certificate /opt/bitnami/nginx/conf/bitnami/certs/${crtFileName};
	ssl_certificate_key /opt/bitnami/nginx/conf/bitnami/certs/${rsaFileName};
	ssl_protocols TLSv1.2;

	server_name  ${vServerName};
        #modsecurity on;
        #modsecurity_rules_file /etc/nginx/modsec/main.conf;

	include server_blocks/${postFix}.xversion;

	location /livehub {
              proxy_pass https://enable-chathub-${postFix};
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header Host $host;

              proxy_http_version 1.1;

              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection $connection_upgrade;
	}

	location /auth {
              proxy_set_header HOST $host;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header 'Access-Control-Allow-Credentials' 'true';
              proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

              add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
              proxy_pass https://enable-auth-${postFix};
	}

	location /storage {
              client_max_body_size 50M;
              proxy_set_header HOST $host;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header 'Access-Control-Allow-Credentials' 'true';
              proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
              
              add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
              proxy_pass https://enable-storage-${postFix};
 	}

	location /api {
                client_max_body_size 50M;

                proxy_set_header HOST $host;
                proxy_set_header X-Forwarded-Proto $scheme;

                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header 'Access-Control-Allow-Credentials' 'true';
                proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
		add_header X-Version-FE $XVersionFE;
                add_header X-Version-Config $XVersionConfig;

                ## remove the old header
                proxy_hide_header 'Access-Control-Expose-Headers';
                add_header 'Access-Control-Expose-Headers' 'Location,Upload-Offset,Upload-Length,X-Pagination,X-Version,Content-Disposition,X-Version-FE,X-Version-Config';

                if ($http_referer ~* ^https://${vServerName}/admin/swagger/index.html) {
                        proxy_pass https://enable-apiadmin-${postFix};
                }

              proxy_pass https://enable-api-${postFix};
        }
        
        location /apiadmin {
                proxy_set_header HOST $host;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header 'Access-Control-Allow-Credentials' 'true';
                proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
		proxy_send_timeout 300;
		proxy_read_timeout 300;

                proxy_pass https://enable-apiadmin-${postFix}/api;
        }	
        
        location /admin/swagger {
                proxy_set_header HOST $host;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_set_header 'Access-Control-Allow-Credentials' 'true';
                proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

                proxy_pass https://enable-apiadmin-${postFix};
        }

        location /swagger {
                proxy_set_header HOST $host;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_set_header 'Access-Control-Allow-Credentials' 'true';
                proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

                proxy_pass https://enable-api-${postFix};
        }
	
	location /ConfigTool {
              proxy_set_header HOST $host;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

              proxy_set_header 'Access-Control-Allow-Credentials' 'true';
              proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

              add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
              # NO caching for configStatic
              proxy_no_cache 1;
              proxy_cache_bypass 1;
              expires off;
              etag off;
              add_header Last-Modified $date_gmt;
              
              proxy_hide_header ETag;
              proxy_hide_header Content-MD5;
              add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';

	      rewrite    ^/ConfigTool(/.*) $1 break;
              proxy_pass https://enable-configui-${postFix};
	}

        location /configStatic {
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

              proxy_set_header 'Access-Control-Allow-Credentials' 'true';
              proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

              add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
              add_header X-Version-Config $XVersionConfig;
              add_header Access-Control-Expose-Headers X-Version-Config;

              # fix http version - 505 HTTP Version Not Supported
              proxy_http_version 1.1;

              rewrite ^/configStatic/(.*)$ /${postFix}/configStatic/$1 break;
              proxy_pass http://${vCDNWebServerName}:80;
        }

        location / {
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

              proxy_set_header 'Access-Control-Allow-Credentials' 'true';
              proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

              add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

              proxy_pass https://${vWebServerName};
        }
}

#server {
#    if ($host = ${vServerName}) {
#        return 301 https://$host$request_uri;
#    }
#    server_name  ${vServerName};
#    listen 80;
#    return 404;
#}

