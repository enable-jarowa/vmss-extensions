upstream enable-auth-${postFix} {
    server ${hostLB}:8000;
}
upstream enable-api-${postFix} {
    server ${hostLB}:8001;
}

upstream enable-apiadmin-${postFix} {
    server ${hostLB}:8002;
}

upstream enable-chathub-${postFix} {
    server ${hostLB}:8010;
}

upstream enable-configui-${postFix} {
    server ${hostLB}:8020;
}

upstream enable-orion-${postFix} {
    server ${hostLB}:8008;
}

server {
    access_log /opt/bitnami/nginx/logs/${postFix}-access.log main;
    error_log /opt/bitnami/nginx/logs/${postFix}-error.log;

    listen [::]:443 ssl http2;
    listen      443 ssl http2;

    server_name  ${vServerName};

    ssl_certificate /opt/bitnami/nginx/conf/bitnami/certs/${crtFileName};
    ssl_certificate_key /opt/bitnami/nginx/conf/bitnami/certs/${rsaFileName};
    ssl_trusted_certificate /opt/bitnami/nginx/conf/bitnami/certs/${crtFileName}.chain.pem;

    set $clusterType "${env}";
    set $maintenanceEnabled "false";
    set $adminDisabled "true";
    set $whitelistadminClusterType "$http_whitelistadmin:$clusterType";
    # disable admin for calls with special header
    if ($whitelistadminClusterType = "${whitelistAdminHeaderPwd}:${env}") {
       set $adminDisabled "false";
    }
    # disable admin for calls with special static header
    if ($whitelistadminClusterType = "${whitelistAdminHeaderStatic}:${env}") {
        set $adminDisabled "false";
    }
    # allow admins if not prod
    if ($clusterType != "prod") {
       set $adminDisabled "false";
    }
    # switch on maint window except special header
    if ($http_whitelistadmin != "${whitelistAdminHeaderPwd}") {
#      set $maintenanceEnabled "true"; # maintenance mode
    }
    # switch off maint window except special static header
    if ($http_whitelistadmin = "${whitelistAdminHeaderStatic}") {
      set $maintenanceEnabled "false";
    }

    ## https://gist.github.com/gavinhungry/7a67174c18085f4a23eb
    ssl_protocols TLSv1.3 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_ecdh_curve secp521r1:secp384r1;
    #ssl_ciphers EECDH+AESGCM:EECDH+AES256;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES128-$';

    # reduce ssl caching to 2m: https://success.qualys.com/discussions/s/question/0D52L00004TntzWSAR/ssltest-protocol-details-session-resumption-caching-in-red-color
    ssl_session_cache shared:TLS:2m;
    ssl_session_cache shared:SSL:2m;
    ssl_session_timeout 2m;
    ssl_buffer_size 4k;
    
    ## https://crashtest-security.com/harden-tls-session-resumption/
    ssl_session_tickets off;

    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    # we dont need a resolver - its defined in azure /etc/resolver.conf
    # resolver 1.1.1.1;
    resolver_timeout 10s;

    # Do not use 2048 (see SSLTEST rating guide)
    # we generated our own using: 
    ssl_dhparam /opt/bitnami/nginx/conf/bitnami/certs/dhparam.pem;

    # do not add this header because must be provided in every location
    # add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;

    # https://blog.adriaan.io/one-nginx-error-page-to-rule-them-all.html
    error_page 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 425 426 428 429 431 451 500 501 502 503 504 505 506 507 508 510 511 /error-pages/error.html;

    location /error-pages {
        ssi on;
        internal; ## served only internal
        auth_basic off;
        root /opt/bitnami/nginx/html;
    }

    include server_blocks/${postFix}*.xversion;

    location /livehub {
        proxy_pass https://enable-chathub-${postFix};
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;

        proxy_http_version 1.1;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    location /auth/.well-known {
        proxy_set_header HOST $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        #proxy_set_header X-Real-IP $remote_addr;

        # use http_x_forwarded_for header only
        proxy_set_header X-Real-IP $http_x_forwarded_for;


        #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-For $http_forwarded_for;
 
        proxy_set_header 'Access-Control-Allow-Credentials' 'true';
        proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        ### we must redeclare the STS header because 'location' block contains another 'add_header' directive
        proxy_hide_header 'Strict-Transport-Security';
        ### and ensure to hide any headers from stream
        add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;

        # for POST SAML response https://ma.ttias.be/nginx-proxy-upstream-sent-big-header-reading-response-header-upstream/
        # and https://support.f5.com/csp/article/K43542013
        proxy_buffer_size          128k;
        proxy_buffers              4 256k;
        proxy_busy_buffers_size    256k;

        ## add additional header for global platform
        proxy_set_header X-Forwarded-Host 'https://${vServerName}';

        proxy_pass https://enable-auth-${regionPostFix};
    }

    location /auth {
        if ($maintenanceEnabled = "true" ){
            rewrite ^ https://www.jarowa.ch/maintenance;
            return 503;
        }
        proxy_set_header HOST $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        #proxy_set_header X-Real-IP $remote_addr;

        # use http_x_forwarded_for header only
        proxy_set_header X-Real-IP $http_x_forwarded_for;


        #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-For $http_forwarded_for;
 
        proxy_set_header 'Access-Control-Allow-Credentials' 'true';
        proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        ### we must redeclare the STS header because 'location' block contains another 'add_header' directive
        proxy_hide_header 'Strict-Transport-Security';
        ### and ensure to hide any headers from stream
        add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;

        # for POST SAML response https://ma.ttias.be/nginx-proxy-upstream-sent-big-header-reading-response-header-upstream/
        # and https://support.f5.com/csp/article/K43542013
        proxy_buffer_size          128k;
        proxy_buffers              4 256k;
        proxy_busy_buffers_size    256k;


        proxy_pass https://enable-auth-${postFix};
    }

    location /api {
        client_max_body_size 50M;

        proxy_set_header HOST $host;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header 'Access-Control-Allow-Credentials' 'true';
        proxy_set_header 'Access-Control-Allow-Methods' 'POST, PATCH, PUT, GET, OPTIONS, DELETE';
        add_header 'Access-Control-Allow-Methods' 'POST, PATCH, PUT, GET, OPTIONS, DELETE';
        add_header X-Version-FE $XVersionFE;
        add_header X-Version-Config $XVersionConfig;

        ## remove the old header
        proxy_hide_header 'Access-Control-Expose-Headers';
        add_header 'Access-Control-Expose-Headers' 'Location,Upload-Offset,Upload-Length,X-Pagination,X-Version,Content-Disposition,X-Version-FE,X-Version-Config';

        ### we must redeclare the STS header because 'location' block contains another 'add_header' directive
        proxy_hide_header 'Strict-Transport-Security';
        ### and ensure to hide any headers from stream
        add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;

        if ($http_referer ~* ^https://${vServerName}/admin/swagger/index.html) {
            proxy_pass https://enable-apiadmin-${postFix};
        }

        proxy_pass https://enable-api-${postFix};
    }

    location /apiadmin {
        proxy_set_header HOST $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header 'Access-Control-Allow-Credentials' 'true';
        proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        proxy_send_timeout 300;
        proxy_read_timeout 300;

        add_header X-Version-FE $XVersionFE;
        add_header X-Version-Config $XVersionConfig;

        ## remove the old header
        proxy_hide_header 'Access-Control-Expose-Headers';
        add_header 'Access-Control-Expose-Headers' 'Location,Upload-Offset,Upload-Length,X-Pagination,X-Version,Content-Disposition,X-Version-FE,X-Version-Config';

        ### we must redeclare the STS header because 'location' block contains another 'add_header' directive
        proxy_hide_header 'Strict-Transport-Security';
        ### and ensure to hide any headers from stream
        add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;

        proxy_pass https://enable-apiadmin-${postFix}/api;
    }

    location /admin/swagger {
        if ($adminDisabled = "true") {
		    return 403;
        }
        proxy_set_header HOST $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_set_header 'Access-Control-Allow-Credentials' 'true';
        proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        ### we must redeclare the STS header because 'location' block contains another 'add_header' directive
        proxy_hide_header 'Strict-Transport-Security';
        ### and ensure to hide any headers from stream
        add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;

        proxy_pass https://enable-apiadmin-${postFix};
    }

    location /swagger {
        if ($adminDisabled = "true") {
		    return 403;
        }
        proxy_set_header HOST $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_set_header 'Access-Control-Allow-Credentials' 'true';
        proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        ### we must redeclare the STS header because 'location' block contains another 'add_header' directive
        proxy_hide_header 'Strict-Transport-Security';
        ### and ensure to hide any headers from stream
        add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;

        proxy_pass https://enable-api-${postFix};
    }

    location /ConfigTool {
        if ($adminDisabled = "true") {
		    return 403;
        }
        proxy_set_header HOST $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_set_header 'Access-Control-Allow-Credentials' 'true';
        proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        ### we must redeclare the STS header because 'location' block contains another 'add_header' directive
        proxy_hide_header 'Strict-Transport-Security';
        ### and ensure to hide any headers from stream
        add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;

        rewrite    ^/ConfigTool(/.*) $1 break;
        proxy_pass https://enable-configui-${postFix};
    }

    location /Orion {
        proxy_set_header HOST $host;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header 'Access-Control-Allow-Credentials' 'true';
        proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        ### we must redeclare the STS header because 'location' block contains another 'add_header' directive
        proxy_hide_header 'Strict-Transport-Security';
        ### and ensure to hide any headers from stream
        add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;

        rewrite ^/Orion/(.*)$ /Orion/$1 break;
        proxy_pass https://enable-orion-${postFix};
    }

    location /configStatic {
        proxy_intercept_errors on;
        error_page 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 425 426 428 429 431 451 500 501 502 503 504 505 506 507 508 510 511 /error-pages/error.html;

        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_set_header 'Access-Control-Allow-Credentials' 'true';
        proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header X-Version-Config $XVersionConfig;
        add_header Access-Control-Expose-Headers X-Version-Config;

        # fix http version - 505 HTTP Version Not Supported
        proxy_http_version 1.1;

        # NO caching for configStatic
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        expires off;
        etag off;
        add_header Last-Modified $date_gmt;

        proxy_hide_header ETag;
        proxy_hide_header Content-MD5;
        add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';

        ### we must redeclare the STS header because 'location' block contains another 'add_header' directive
        proxy_hide_header 'Strict-Transport-Security';
        ### and ensure to hide any headers from stream
        add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;

        rewrite ^/configStatic/(.*)$ /${postFix}/configStatic/$1 break;
        proxy_pass http://${vCDNWebServerNamePrivateLink}:80;
    }

    location / {
        if ($maintenanceEnabled = "true" ){
            rewrite ^ https://www.jarowa.ch/maintenance;
            return 503;
        }
        # https://blog.adriaan.io/one-nginx-error-page-to-rule-them-all.html
        proxy_intercept_errors on;
        error_page 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 425 426 428 429 431 451 500 501 502 503 504 505 506 507 508 510 511 /error-pages/error.html;

        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_set_header 'Access-Control-Allow-Credentials' 'true';
        proxy_set_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

        ### we must redeclare the STS header because 'location' block contains another 'add_header' directive
        proxy_hide_header 'Strict-Transport-Security';
        ### and ensure to hide any headers from stream
        add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;

        # CSP header is needed https://content-security-policy.com/examples/
        proxy_hide_header 'Content-Security-Policy';
        #add_header Content-Security-Policy "frame-ancestors 'self';block-all-mixed-content;default-src 'self';script-src 'self' 'sha256-9LTNKVBb35itFZdQ4CGDKrrmtU5IKnF8bhmOL+UGXvg=' 'sha256-GDKQquENrxJAtR/VNlE5owuMQ6qUYNq6ExDl5+/lrO8=' 'sha256-jqFTTbhSPVRPSVUuIAzEz3XLPfow3hmwfbWjLRoUalI=' 'report-sample' 'unsafe-inline' https://*.sentry.io https://browser.sentry-cdn.com https://cdn.amplitude.com https://js.sentry-cdn.com https://maps.google.com https://maps.googleapis.com https://cdn.enable.jarowa.ch;style-src 'self' 'report-sample' 'unsafe-inline' fonts.googleapis.com;object-src 'none';frame-src 'self' maps.googleapis.com maps.google.com;child-src 'self';img-src 'self' data: blob: *.gstatic.com *.googleapis.com *.ggpht.com maps.googleapis.com maps.google.com purecatamphetamine.github.io cdn.enable.jarowa.ch;font-src 'self' data: fonts.googleapis.com fonts.gstatic.com;connect-src 'self' *.amplitude.com *.sentry.io fonts.gstatic.com fonts.googleapis.com maps.google.com maps.googleapis.com sentry.io cdn.enable.jarowa.ch;manifest-src 'self';base-uri 'self';form-action 'self';media-src 'self';prefetch-src 'self';worker-src 'self'";

        proxy_set_header HOST ${vWebServerName};
        proxy_pass https://${vWebServerNamePrivateLink};
    }
}

#server {
#    listen [::]:80;
#    listen      80;
#    server_name  ${vServerName};
#    rewrite ^ https://$host$request_uri? permanent;
#}

